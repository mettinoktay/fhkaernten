#include "stm32f4xx_hal.h"
#include "stm32f4xx_hal_i2c.h"

#include "tcs34725.h"

uint8_t tx_buf[2];
uint8_t rx_buf[6];

void TCS34725_Init()
{
	tx_buf[0] = TCS34725_ATIME | TCS34725_COMMAND_BIT;
	tx_buf[1] = TCS34725_INTEGRATIONTIME_50MS;
	HAL_I2C_Master_Transmit(&hi2c1, TCS34725_ADDRESS, tx_buf, 2, 100);
	
	tx_buf[0] = TCS34725_CONTROL | TCS34725_COMMAND_BIT;
	tx_buf[1] = TCS34725_GAIN_4X;
	HAL_I2C_Master_Transmit(&hi2c1, TCS34725_ADDRESS, tx_buf, 2, 100);

	tx_buf[0] = TCS34725_ENABLE | TCS34725_COMMAND_BIT;
	tx_buf[1] = TCS34725_ENABLE_PON | TCS34725_ENABLE_AEN;
	HAL_I2C_Master_Transmit(&hi2c1, TCS34725_ADDRESS, tx_buf, 2, 100);
}
	
	
void TCS34725_GetValues(uint16_t* pValues)
{
	tx_buf[0] = TCS34725_CDATAL | TCS34725_COMMAND_BIT;
	HAL_I2C_Master_Transmit(&hi2c1, TCS34725_ADDRESS, tx_buf, 1, 100);
	HAL_I2C_Master_Receive(&hi2c1, TCS34725_ADDRESS, rx_buf, 8, 100);
		
	pValues[0] = (rx_buf[0] | rx_buf[1] << 8);
	pValues[1] = (rx_buf[2] | rx_buf[3] << 8);
	pValues[2] = (rx_buf[4] | rx_buf[5] << 8);
	pValues[3] = (rx_buf[6] | rx_buf[7] << 8);
}